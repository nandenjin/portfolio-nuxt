<template>
  <main class="maiin doc">
    <ul class="link-list">
      <li v-for="item in pages" :key="item.name" class="item">
        <nuxt-link :to="item.path.replace(/^\/pages/, '')" class="item-content">
          <span class="title">{{ item.title_ja }}</span>
          <span class="date">{{ item.release.replace(/T.+$/, '') }}</span>
        </nuxt-link>
      </li>
    </ul>
  </main>
</template>

<script lang="ts">
import { IContentDocument } from '@nuxt/content/types/content'
import { defineComponent, useAsync, useContext } from '@nuxtjs/composition-api'
import { NuxtRootContext } from '~/types'

export default defineComponent({
  setup() {
    const { $content } = useContext() as NuxtRootContext
    const pages = useAsync(async () => {
      const src = (await $content(
        'pages/news/index'
      ).fetch()) as IContentDocument // ToDo: make typed correctly
      const items: string[] = []
      const proc = node => {
        if (node.type === 'text') {
          return
        }
        if (node.tag === 'nuxt-link') {
          items.push(node.props.to)
        }
        for (const c of node.children) {
          proc(c)
        }
      }
      proc(src.body)

      const pages = await Promise.all(
        items.map(path => $content(path.replace(/\.md$/, '')).fetch())
      )

      return pages
    })

    return { pages }
  },
  head: {
    title: 'News',
    meta: [
      {
        hid: 'og:title',
        property: 'og:title',
        content: 'News - Kazumi Inada'
      }
    ]
  }
})
</script>

<style lang="sass" scoped>

@import '~/assets/style/media.sass'

.link-list
  padding: 0
  list-style: none

  .item
    font-size: 13px
    line-height: 2em
    border: 1px solid #eee
    border-style: solid none
    cursor: pointer

    & + .item
      border-top: none

    .item-content
      display: flex
      padding: 20px 30px
      color: inherit

      +rmq
        display: block
        padding: 20px 15px


      .title
        display: block
        flex: 1 1 auto

      .date
        display: block
        flex: 0 0 auto
        color: #888
        font-family: Helvetica
</style>
